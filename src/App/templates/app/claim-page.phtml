<?php $this->layout('layout::three-column', ['title' => 'Claim', 'claim' => $claim]);

/**
 * @var \Opg\Refunds\Caseworker\DataModel\Cases\Claim $claim
 * @var \App\Form\AbstractForm $form
 */

$this->addErrorMap([
    'message' => [
        'required' => [
            'summary'   => 'Please enter a user log message',
            'field'     => 'Enter a user log message'
        ]
    ]
]);
?>

<?php $this->start('left-sidebar');

$application = $claim->getApplication();
$donor = $application->getDonor();
$attorney = $application->getAttorney();
$postcodes = $application->getPostcodes();
$contact = $application->getContact();
?>

<h2 class="heading-medium">Donor details</h2>

<h3 class="heading-small">Name:</h3>
<p><?= $this->getFormattedName($donor->getName()) ?></p>

<h3 class="heading-small">Date of birth:</h3>
<p><?= $this->getDateOfBirthString($donor->getDob()) ?></p>

<?php if ($donor->getPoaName() !== null) { ?>
    <h3 class="heading-small">Name on power attorney documents:</h3>
    <p><?= $this->getFormattedName($donor->getPoaName()) ?></p>
<?php } ?>

<h2 class="heading-medium">Attorney details</h2>

<h3 class="heading-small">Name:</h3>
<p><?= $this->getFormattedName($attorney->getName()) ?></p>

<h3 class="heading-small">Date of birth:</h3>
<p><?= $this->getDateOfBirthString($attorney->getDob()) ?></p>

<?php if ($attorney->getPoaName() !== null) { ?>
    <h3 class="heading-small">Name on power attorney documents:</h3>
    <p><?= $this->getFormattedName($attorney->getPoaName()) ?></p>
<?php } ?>

<h2 class="heading-medium">Verification details</h2>

<h3 class="heading-small">
    <i class="icon icon-important">
        <span class="visually-hidden">Warning</span>
    </i>
    Claim unverified
</h3>

<h3 class="heading-small">Attorney details</h3>

<?php if ($application->getCaseNumber()->getPoaCaseNumber() !== null) { ?>
    <h3 class="heading-small">Case number:</h3>
    <p><?= $application->getCaseNumber()->getPoaCaseNumber() ?></p>
<?php } ?>

<?php if ($postcodes->getDonorPostcode() !== null) { ?>
    <h3 class="heading-small">Donor postcode:</h3>
    <p><?= $postcodes->getDonorPostcode() ?></p>
<?php } ?>

<?php if ($postcodes->getAttorneyPostcode() !== null) { ?>
    <h3 class="heading-small">Attorney postcode:</h3>
    <p><?= $postcodes->getAttorneyPostcode() ?></p>
<?php } ?>

<h2 class="heading-medium">Contact details</h2>

<h3 class="heading-small">Applicant:</h3>
<p><?= $this->getApplicantName($application) ?></p>

<?php if ($contact->getEmail() !== null) { ?>
    <h3 class="heading-small">Email:</h3>
    <p><?= $contact->getEmail() ?></p>
<?php } ?>

<?php if ($contact->getPhone() !== null) { ?>
    <h3 class="heading-small">Telephone:</h3>
    <p><?= $contact->getPhone() ?></p>
<?php } ?>

<?php $this->stop() ?>

<?php $this->start('right-sidebar');

$payment = $claim->getPayment();
?>

<h2 class="heading-medium">Payment details</h2>

<h3 class="heading-small">Refund made via:</h3>
<p>Bank transfer</p>

<h3 class="heading-small">Total refund amount:</h3>
<p>Â£0.00</p>

<h3 class="heading-small">
    <?php if ($this->shouldShowPaymentDetailsUsedCountWarning($claim->getAccountHashCount())) { ?>
        <i class="icon icon-important">
            <span class="visually-hidden">Warning</span>
        </i>
    <?php } ?>
    <?= $this->getPaymentDetailsUsedText($claim->getAccountHashCount()) ?>
</h3>

<?php $this->stop() ?>

<?php $this->insert('snippet::error-summary', [ 'form'=>$form ]) ?>

<div>
    <h2 class="heading-medium">Sirius power of attorneys</h2>

    <?php if ($claim->isNoSiriusPoas()) { ?>
        <a class="button" href="/claim/<?= $claim->getId() ?>/poa/sirius/cancel-none-found">Cancel and return to add Sirius POA</a>
    <?php } else { ?>
        <a class="button" href="/claim/<?= $claim->getId() ?>/poa/sirius/add">Add Sirius POA</a>
        <a class="button" href="/claim/<?= $claim->getId() ?>/poa/sirius/none-found">No Sirius POAs found</a>
    <?php } ?>
</div>

<div>
    <h2 class="heading-medium">Meris power of attorneys</h2>

    <?php if ($claim->isNoMerisPoas()) { ?>
        <a class="button" href="/claim/<?= $claim->getId() ?>/poa/meris/cancel-none-found">Cancel and return to add Meris POA</a>
    <?php } else { ?>
        <a class="button" href="/claim/<?= $claim->getId() ?>/poa/meris/add">Add Meris POA</a>
        <a class="button" href="/claim/<?= $claim->getId() ?>/poa/meris/none-found">No Meris POAs found</a>
    <?php } ?>
</div>

<h2 class="heading-medium">User log</h2>

<form method="post" class="form">

    <?php $this->insert('snippet::form-csrf', ['form' => $form]) ?>

    <fieldset>

        <?php $this->insert('snippet::input-text', [
            'formElement' => $form->get('message'),
            'formLabel' => 'Add a user log',
            'formType' => 'textarea',
            'formLabelBold' => false
        ]) ?>

    </fieldset>

    <div class="form-group">
        <input type="submit" class="button" value="Submit log" />
    </div>

</form>

<?php foreach ($claim->getLogs() as $log) { ?>
    <?php /** @var \Opg\Refunds\Caseworker\DataModel\Cases\Log $log */ ?>
    <div>
        <h3 class="heading-small"><?= $this->getLogDateString($log->getCreatedDateTime()) ?> <?= $this->getLogTimeString($log->getCreatedDateTime()) ?></h3>
        <h4 class="heading-small"><?= $log->getTitle() ?></h4>
        <p><?= $log->getMessage() ?></p>
        <?php if ($log->getUserName() !== null) { ?>
            <p>by <?= $log->getUserName() ?></p>
        <?php } ?>
    </div>
<?php } ?>
